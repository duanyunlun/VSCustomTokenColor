name: Publish to VS Code Marketplace

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci

      - name: Validate publisher
        run: |
          node -e "const p=require('./package.json'); if(p.publisher==='local'){console.error('package.json.publisher is \"local\". Set it to your Marketplace Publisher ID before publishing.'); process.exit(1)}"

      - name: Validate tag matches version
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          node -e "const p=require('./package.json'); const tag=process.env.GITHUB_REF_NAME; const v=tag.startsWith('v')?tag.slice(1):tag; if(p.version!==v){console.error(`Tag version (${v}) does not match package.json version (${p.version}).`); process.exit(1)}"

      - run: npm run compile
      - run: npm run package

      - name: Create GitHub Release and upload VSIX
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          tag="${GITHUB_REF_NAME}"
          gh release view "$tag" >/dev/null 2>&1 && exit 0
          gh release create "$tag" --generate-notes *.vsix

      - name: Publish
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: npx vsce publish --pat "$VSCE_PAT" --githubBranch main
