name: Publish to VS Code Marketplace

on:
  workflow_run:
    workflows: ["Bump version and tag"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag:
        description: "可选：指定要发布的 tag（例如 v0.0.2）。留空则发布当前 main（不创建 Release）。"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  publish:
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Resolve checkout ref
        id: ref
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            # bump.yml 会在 workflow 内部新建 “chore(release): vX.Y.Z” 提交并推送到 main；
            # workflow_run.head_sha 是触发 bump 的原始提交，不是 bump 生成的发布提交。
            # 因此这里直接拉取最新 main 来打包/发布。
            echo "ref=main" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ -n "${{ inputs.tag }}" ]]; then
            echo "ref=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ref=main" >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.ref.outputs.ref }}
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci

      - name: Validate publisher
        run: |
          node -e "const p=require('./package.json'); if(p.publisher==='local'){console.error('package.json.publisher is \"local\". Set it to your Marketplace Publisher ID before publishing.'); process.exit(1)}"

      - name: Resolve publish tag (if any)
        id: tag
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.tag }}" ]]; then
            echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            tag="$(git tag --points-at HEAD | sort -V | tail -n 1)"
            echo "tag=$tag" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "tag=" >> "$GITHUB_OUTPUT"

      - name: Validate tag matches version
        if: steps.tag.outputs.tag != ''
        run: |
          node -e "const p=require('./package.json'); const tag='${{ steps.tag.outputs.tag }}'; const v=tag.startsWith('v')?tag.slice(1):tag; if(p.version!==v){console.error(`Tag version (${v}) does not match package.json version (${p.version}).`); process.exit(1)}"

      - run: npm run compile
      - run: npm run package

      - name: Create/Update GitHub Release and upload VSIX
        if: steps.tag.outputs.tag != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          generate_release_notes: true
          files: "*.vsix"

      - name: Publish
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          if [ -z "$VSCE_PAT" ]; then
            echo "Missing VSCE_PAT. Add it in GitHub -> Settings -> Secrets and variables -> Actions -> New repository secret."
            exit 1
          fi
          npx vsce publish --pat "$VSCE_PAT" --githubBranch main --packagePath *.vsix --skip-duplicate --skip-license
